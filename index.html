<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Valentine?</title>
  <style>
    :root{
      --card: rgba(255,255,255,.78);
      --text: #241a22;
      --shadow: 0 22px 60px rgba(35, 20, 40, .18);
      --pink: #ff3b7a;
      --pink2:#ff6aa2;
      --dark: rgba(0,0,0,.86);
      --bg1: #fff2f7;
      --bg2: #fff3ea;
      --bg3: #eef8ff;
      --bg4: #fff0f5;
    }
    body.night{
      --card: rgba(20,16,26,.62);
      --text: rgba(255,255,255,.92);
      --shadow: 0 22px 60px rgba(0,0,0,.45);
      --bg1: #140a1a;
      --bg2: #0d1022;
      --bg3: #0b1a22;
      --bg4: #1c0f1b;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; color:var(--text); }
    body{
      overflow:hidden;
      background: linear-gradient(120deg, var(--bg1), var(--bg2), var(--bg3), var(--bg4));
      background-size: 300% 300%;
      animation: bgShift 14s ease-in-out infinite;
    }
    @keyframes bgShift{
      0%{ background-position: 0% 50%; }
      50%{ background-position: 100% 50%; }
      100%{ background-position: 0% 50%; }
    }

    .wrap{
      height:100%;
      display:grid;
      place-items:center;
      padding: max(14px, env(safe-area-inset-top)) 14px max(14px, env(safe-area-inset-bottom));
    }
    .card{
      width:min(760px, 96vw);
      padding: 22px 18px 18px;
      border-radius:22px;
      background: var(--card);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.40);
      position:relative;
      overflow:hidden;
    }

    h1{
      margin:0 0 6px;
      font-size: clamp(22px, 4.8vw, 46px);
      letter-spacing: -0.02em;
      text-align:center;
      min-height: 1.2em;
    }
    p{ margin:0 0 10px; text-align:center; opacity:.82; font-size:14.5px; }

    /* 5) Compliment line */
    .compliment{
      text-align:center;
      font-weight: 900;
      font-size: 13px;
      opacity: .78;
      margin: 0 0 10px;
      transition: opacity .25s ease, transform .25s ease;
    }
    .compliment.bump{ opacity: 1; transform: translateY(2px); }

    /* Name input row - fixed layout */
    .name-row{
      display:flex;
      gap:10px;
      justify-content:center;
      align-items:center;
      flex-wrap:wrap;
      margin: 6px 0 12px;
    }
    .name-row input{
      flex: 1 1 220px;
      min-width: 180px;
      max-width: 360px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.75);
      outline: none;
      font-weight: 800;
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
      color: inherit;
    }
    body.night .name-row input{
      background: rgba(255,255,255,.10);
      border-color: rgba(255,255,255,.15);
    }

    .gif-wrap{ display:grid; place-items:center; margin: 6px 0 10px; }
    .gif{
      width:min(260px, 72vw);
      border-radius:18px;
      box-shadow: 0 14px 40px rgba(0,0,0,.12);
      border:1px solid rgba(255,255,255,.35);
      background: rgba(255,255,255,.18);
      overflow:hidden;
    }
    .gif img{ display:block; width:100%; height:auto; }

    .topbar{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      margin: 8px 0 10px;
    }
    .pill{
      border:1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.7);
      backdrop-filter: blur(8px);
      border-radius:999px;
      padding:8px 12px;
      font-weight:800;
      font-size:13px;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
      color: inherit;
      -webkit-tap-highlight-color: transparent;
    }
    body.night .pill{
      background: rgba(255,255,255,.12);
      border-color: rgba(255,255,255,.12);
      box-shadow: 0 14px 30px rgba(0,0,0,.25);
    }
    .pill:active{ transform: translateY(1px); }

    .meter{
      margin: 10px auto 0;
      width: min(520px, 94%);
      background: rgba(255,255,255,.65);
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 999px;
      padding: 6px;
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
      color: inherit;
    }
    body.night .meter{
      background: rgba(255,255,255,.10);
      border-color: rgba(255,255,255,.12);
    }
    .meter-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:6px;
      font-size:12px;
      font-weight:900;
      opacity:.9;
      padding: 0 6px;
    }
    .bar{ height: 14px; background: rgba(0,0,0,.10); border-radius: 999px; overflow:hidden; }
    body.night .bar{ background: rgba(255,255,255,.10); }
    .fill{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #ff3b7a, #ff6aa2);
      border-radius: 999px;
      transition: width .25s ease;
    }

    /* ‚úÖ Stage layout fixed (works great on mobile) */
    .stage{
      position:relative;
      height: 210px;
      width:100%;
      display:block;
      margin-top: 10px;
      border-radius: 18px;
      background: rgba(255,255,255,.22);
      border: 1px solid rgba(255,255,255,.35);
      overflow:hidden;
      touch-action: manipulation;
    }
    body.night .stage{
      background: rgba(0,0,0,.14);
      border-color: rgba(255,255,255,.12);
    }

    .btn{
      border:0;
      padding:14px 22px;
      border-radius:14px;
      font-weight:900;
      font-size:18px;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
      box-shadow: 0 10px 22px rgba(0,0,0,.12);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      position:absolute;
      will-change: transform, left, top;
      white-space: nowrap;
    }
    .btn:active{ transform: translate(-50%,-50%) scale(.99); }

    #yes{
      background: linear-gradient(135deg, var(--pink), var(--pink2));
      color:white;
      left: 50%;
      top: 40%;
      transform: translate(-50%,-50%);
      animation: yesPulse 1.6s ease-in-out infinite;
    }
    @keyframes yesPulse{
      0%,100%{ box-shadow: 0 10px 22px rgba(0,0,0,.12), 0 0 0 rgba(255,59,122,0); filter: saturate(1); }
      50%{ box-shadow: 0 10px 22px rgba(0,0,0,.12), 0 0 28px rgba(255,59,122,.35); filter: saturate(1.08); }
    }
    #no{
      background: var(--dark);
      color:white;
      left: 50%;
      top: 72%;
      transform: translate(-50%,-50%);
    }

    .counter{ text-align:center; margin-top: 10px; font-size: 13px; font-weight: 900; opacity:.82; }
    .hint{ margin-top: 8px; text-align:center; font-size:12px; opacity:.55; }

    .overlay{ position:fixed; inset:0; pointer-events:none; opacity:0; transition: opacity .35s ease; }
    .overlay.on{ opacity:1; }

    .badge{
      position:absolute; left:50%; top:10%;
      transform: translateX(-50%);
      text-align:center; font-weight:1000;
      font-size: clamp(18px, 3.2vw, 34px);
      color: #ff2f74;
      text-shadow: 0 10px 30px rgba(255, 47, 116, .18);
      padding: 10px 16px; border-radius: 999px;
      background: rgba(255,255,255,.70);
      border:1px solid rgba(255,255,255,.85);
      backdrop-filter: blur(10px);
      max-width: 92vw;
    }
    body.night .badge{ background: rgba(0,0,0,.35); border-color: rgba(255,255,255,.20); }

    .submsg{
      position:absolute; left:50%; top:20%;
      transform: translateX(-50%);
      text-align:center; font-weight:900;
      font-size: clamp(13px, 2.4vw, 18px);
      opacity:0;
      transition: opacity .4s ease, transform .4s ease;
      background: rgba(255,255,255,.62);
      border:1px solid rgba(255,255,255,.85);
      backdrop-filter: blur(10px);
      padding: 10px 14px; border-radius: 16px;
      max-width: 92vw;
      pointer-events:none;
    }
    body.night .submsg{ background: rgba(0,0,0,.35); border-color: rgba(255,255,255,.20); }
    .submsg.on{ opacity:1; transform: translateX(-50%) translateY(6px); }

    #compatWrap{ top: 25%; }
    #dateBox{ top: 33%; opacity:0; pointer-events:none; }
    #dateBox.on{ opacity:1; pointer-events:auto; }

    .compat{
      display:inline-flex;
      gap:8px;
      align-items:center;
      justify-content:center;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.62);
      border: 1px solid rgba(255,255,255,.85);
      backdrop-filter: blur(10px);
      font-weight: 1000;
      font-size: 13px;
      max-width: 92vw;
    }
    body.night .compat{ background: rgba(0,0,0,.35); border-color: rgba(255,255,255,.20); }

    .letter{
      position:absolute; left:50%; top:48%;
      transform: translateX(-50%);
      width: min(680px, 94vw);
      background: rgba(255,255,255,.82);
      border:1px solid rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-radius: 22px;
      box-shadow: 0 22px 60px rgba(0,0,0,.14);
      padding: 14px 14px 16px;
      opacity:0; pointer-events:none;
      transition: opacity .45s ease, transform .45s ease;
      color: inherit;
    }
    body.night .letter{
      background: rgba(0,0,0,.38);
      border-color: rgba(255,255,255,.20);
      box-shadow: 0 22px 60px rgba(0,0,0,.45);
    }
    .letter.on{ opacity:1; pointer-events:auto; transform: translateX(-50%) translateY(8px); }
    .letter h3{ margin:0 0 8px; font-size: 16px; font-weight: 1000; text-align:center; color:#ff2f74; }
    .letter-body{ font-size: 14px; line-height: 1.55; font-weight: 800; opacity: .92; white-space: pre-wrap; }
    .letter-actions{ display:flex; justify-content:center; gap:10px; margin-top: 10px; flex-wrap:wrap; }

    .fall-layer{ position:fixed; inset:0; pointer-events:none; overflow:hidden; }
    .fall{
      position:absolute; top:-60px; font-size: 28px;
      will-change: transform, opacity;
      filter: drop-shadow(0 6px 12px rgba(0,0,0,.12));
      animation: fall linear forwards;
    }
    @keyframes fall{ to{ transform: translate(var(--dx), calc(100vh + 120px)) rotate(var(--rot)); opacity:.95; } }

    canvas#fx{ position:fixed; inset:0; width:100%; height:100%; pointer-events:none; }

    /* 7) Glitter trail */
    canvas#glitter{ position:fixed; inset:0; width:100%; height:100%; pointer-events:none; opacity: .85; }

    .cursor-heart{
      position: fixed; left: 0; top: 0;
      transform: translate(-50%,-50%);
      pointer-events:none; font-size: 22px;
      opacity: 0; transition: opacity .2s ease;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,.15));
      z-index: 9999;
    }
    .cursor-heart.on{ opacity: 0.95; }

    .modal{
      position: fixed; inset:0; display:none; place-items:center;
      background: rgba(0,0,0,.25); backdrop-filter: blur(6px); z-index: 9998;
    }
    .modal.on{ display:grid; }
    .modal-card{
      width: min(520px, 92vw);
      background: rgba(255,255,255,.86);
      border:1px solid rgba(255,255,255,.9);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 18px;
      text-align:center;
      color: inherit;
    }
    body.night .modal-card{ background: rgba(0,0,0,.45); border-color: rgba(255,255,255,.20); }
    .modal-card h2{ margin: 0 0 6px; font-size: 20px; }
    .modal-card p{ margin: 0 0 14px; opacity:.75; font-size: 13px; }
    .modes{ display:grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .mode{
      padding: 12px 10px; border-radius: 18px;
      border: 1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.75);
      cursor:pointer; font-weight: 900;
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
      color: inherit;
    }
    body.night .mode{ background: rgba(255,255,255,.12); border-color: rgba(255,255,255,.12); }
    .mode small{ display:block; margin-top:6px; font-weight:800; opacity:.65; }
    @media (max-width: 420px){ .modes{ grid-template-columns: 1fr; } }

    #yt-holder{
      position: fixed; width: 1px; height: 1px;
      left: -10px; top: -10px;
      overflow: hidden; opacity: 0.001; pointer-events: none;
    }
  </style>
</head>
<body>
  <canvas id="glitter"></canvas>

  <div class="wrap">
    <div class="card" id="card">
      <h1 id="title"></h1>
      <p id="subtitle">Choose wisely.</p>

      <div class="compliment" id="compliment">Loading compliment‚Ä¶</div>

      <div class="name-row">
        <input id="nameInput" type="text" inputmode="text" maxlength="40" placeholder="Enter their name (optional) üíå" />
        <button class="pill" id="setNameBtn">‚ú® Set</button>
      </div>

      <div class="gif-wrap">
        <div class="gif">
          <img id="gif" src="https://media.giphy.com/media/MDJ9IbxxvDUQM/giphy.gif" alt="Cute valentine gif" loading="eager">
        </div>
      </div>

      <div class="topbar">
        <div class="pill" id="musicBtn">üîá Music</div>
        <div class="pill" id="modeBtn">üß† Mode: Cute</div>
        <div class="pill" id="shareBtn">üíå Share</div>
      </div>

      <div class="meter" aria-label="Love meter">
        <div class="meter-row">
          <div id="meterLabel">Love Meter üíò</div>
          <div id="meterPct">0%</div>
        </div>
        <div class="bar"><div class="fill" id="meterFill"></div></div>
      </div>

      <div class="stage" id="stage">
        <button class="btn" id="yes" aria-label="Yes">Yes üíñ</button>
        <button class="btn" id="no" aria-label="No">No üôÉ</button>
      </div>

      <div class="counter" id="counter">Kisses sent: 0 üíã</div>
      <div class="hint">(Hover or tap ‚ÄúNo‚Äù üòà ‚Ä¢ Type ‚ÄúLOVE‚Äù ‚Ä¢ Konami code too üòâ)</div>
    </div>
  </div>

  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="badge" id="badge">YAYYYYY üíòüå∏‚ú®</div>

    <div class="submsg" id="submsg">PS: You just made my whole year üíñ</div>

    <div class="submsg" id="compatWrap">
      <div class="compat" id="compatChip">Compatibility: calculating‚Ä¶</div>
    </div>

    <div class="submsg" id="dateBox">
      <div style="font-weight:1000; margin-bottom:6px;">Our date idea üçïüé¨üåô</div>
      <div id="dateIdea" style="font-weight:900; opacity:.9;">Loading‚Ä¶</div>
      <div style="margin-top:10px;">
        <button id="newIdeaBtn" class="pill" style="pointer-events:auto;">üîÑ New idea</button>
      </div>
    </div>

    <div class="letter" id="letter">
      <h3 id="letterTitle">A little note üíå</h3>
      <div class="letter-body" id="letterBody"></div>
      <div class="letter-actions">
        <button class="pill" id="copyLetterBtn" style="pointer-events:auto;">üìã Copy</button>
        <button class="pill" id="rerollLetterBtn" style="pointer-events:auto;">‚ú® New version</button>
      </div>
    </div>
  </div>

  <div class="fall-layer" id="fallLayer" aria-hidden="true"></div>
  <canvas id="fx"></canvas>
  <div class="cursor-heart" id="cursorHeart">üíó</div>

  <div class="modal" id="modal" aria-hidden="true">
    <div class="modal-card">
      <h2>Pick a vibe</h2>
      <p>This changes emojis, fireworks intensity, and the little messages ‚ú®</p>
      <div class="modes">
        <div class="mode" data-mode="cute">üê± Cute<small>soft + sweet</small></div>
        <div class="mode" data-mode="chaotic">üòà Chaotic<small>more fireworks</small></div>
        <div class="mode" data-mode="nerdy">ü§ì Nerdy<small>geeky love</small></div>
      </div>
      <div style="margin-top:12px; font-size:12px; opacity:.55;">Tap outside to close</div>
    </div>
  </div>

  <div id="yt-holder"><div id="yt-player"></div></div>
  <script src="https://www.youtube.com/iframe_api"></script>

<script>
(() => {
  // 9) Auto-theme based on time
  const hour = new Date().getHours();
  if(hour >= 19 || hour < 6) document.body.classList.add("night");

  const stage = document.getElementById('stage');
  const noBtn = document.getElementById('no');
  const yesBtn = document.getElementById('yes');
  const overlay = document.getElementById('overlay');
  const fallLayer = document.getElementById('fallLayer');
  const titleEl = document.getElementById('title');
  const badgeEl = document.getElementById('badge');
  const submsgEl = document.getElementById('submsg');
  const counterEl = document.getElementById('counter');
  const cursorHeart = document.getElementById('cursorHeart');

  const musicBtn = document.getElementById('musicBtn');
  const modeBtn = document.getElementById('modeBtn');
  const shareBtn = document.getElementById('shareBtn');
  const modal = document.getElementById('modal');

  const dateBox = document.getElementById('dateBox');
  const dateIdeaEl = document.getElementById('dateIdea');
  const newIdeaBtn = document.getElementById('newIdeaBtn');

  const meterFill = document.getElementById('meterFill');
  const meterPct = document.getElementById('meterPct');
  const meterLabel = document.getElementById('meterLabel');

  const letter = document.getElementById('letter');
  const letterTitle = document.getElementById('letterTitle');
  const letterBody = document.getElementById('letterBody');
  const copyLetterBtn = document.getElementById('copyLetterBtn');
  const rerollLetterBtn = document.getElementById('rerollLetterBtn');

  const nameInput = document.getElementById('nameInput');
  const setNameBtn = document.getElementById('setNameBtn');

  const complimentEl = document.getElementById('compliment');

  const compatWrap = document.getElementById('compatWrap');
  const compatChip = document.getElementById('compatChip');

  function rand(min,max){ return Math.random()*(max-min)+min; }

  // Name handling
  const params = new URLSearchParams(location.search);
  const fromQuery = (params.get('name') || "").trim();
  const fromStorage = (localStorage.getItem("valentine_name") || "").trim();

  function sanitizeName(n){
    return (n || "").trim().replace(/[<>]/g, "").slice(0, 40);
  }

  let currentName = sanitizeName(fromQuery || fromStorage);

  function typewriter(el, text, speed=28){
    el.textContent = "";
    let i = 0;
    const t = setInterval(() => {
      el.textContent += text[i++];
      if(i >= text.length) clearInterval(t);
    }, speed);
  }

  function updateTitle(){
    const who = currentName ? `, ${currentName}` : "";
    typewriter(titleEl, `Will you be my valentine${who}? üíò`, 26);
    nameInput.value = currentName || "";
  }

  function setName(n){
    currentName = sanitizeName(n);
    localStorage.setItem("valentine_name", currentName);
    updateTitle();
    setCompliment(true);
  }

  nameInput.value = currentName || "";
  setNameBtn.addEventListener('click', () => setName(nameInput.value));
  nameInput.addEventListener('keydown', (e) => { if(e.key === "Enter") setName(nameInput.value); });

  updateTitle();

  // 5) Compliments
  const COMPLIMENTS = [
    "Your smile is genuinely dangerous. üò≥",
    "You have main-character energy, and I‚Äôm here for it. ‚ú®",
    "If cute was a sport, you‚Äôd be undefeated. üèÜ",
    "You make the world feel softer. üå∏",
    "You‚Äôre basically a serotonin factory. üíñ",
    "You‚Äôre the kind of person people write songs about. üé∂",
    "You‚Äôre a 10‚Ä¶ and also a sweetheart. üíò",
    "You make simple moments feel special. ü´∂",
    "Plot twist: I‚Äôm already a little obsessed. üôÉ",
    "You‚Äôre adorable. This is not a debate. ‚úÖ"
  ];
  function setCompliment(bump=false){
    const n = currentName || "you";
    const base = COMPLIMENTS[Math.floor(Math.random()*COMPLIMENTS.length)];
    // gentle personalization without breaking grammar
    const c = currentName ? base.replace(/^You/, `${currentName}, you`) : base;
    complimentEl.textContent = c.replace("you‚Äôd", `${n}‚Äôd`);
    if(bump){
      complimentEl.classList.add("bump");
      setTimeout(() => complimentEl.classList.remove("bump"), 260);
    }
  }
  setCompliment(false);
  setInterval(() => setCompliment(true), 9000);

  // Date ideas
  const DATE_IDEAS = [
    "üçï Pizza + a cozy movie night (you pick the movie, I pick the snacks)",
    "üåô Night drive + playlist battle + hot chocolate stop",
    "üé≥ Bowling + arcade + winner chooses dessert",
    "üç£ Sushi date + try one ‚Äúmystery roll‚Äù together",
    "üåÜ Sunset walk + random photoshoot challenge",
    "üé® Paint & sip at home (chaotic art is encouraged)",
    "üß∫ Picnic indoors (blanket + candles + cute playlist)",
    "üéÆ Co-op game night (Portal vibes) + nachos",
    "üçî Street food mission: try 3 places, rate them like judges",
    "üßÅ Bake cookies together + taste-test the disasters",
    "‚òï Caf√© hop + ‚Äúpick each other‚Äôs drink‚Äù challenge",
    "üõçÔ∏è Mini thrift hunt + pick a silly outfit for each other",
    "üì∏ Photo scavenger hunt: find 10 cute things in town",
    "üåå Stargazing + ‚Äòtell me your dream life‚Äô conversation",
    "üé§ Karaoke at home + dramatic performances only",
    "üß© Puzzle night + ‚Äòloser‚Äô gives a massage",
    "üöó Drive to a viewpoint + fries + deep talks",
    "üç¶ Ice cream + walk + make up stories about strangers (nicely)",
    "üé¨ Movie theater + post-movie review like film critics",
    "üå∏ Botanical garden + cute selfies + lemonade"
  ];
  function pickDateIdea(){ dateIdeaEl.textContent = DATE_IDEAS[Math.floor(Math.random()*DATE_IDEAS.length)]; }
  newIdeaBtn.addEventListener('click', (e) => { e.preventDefault(); pickDateIdea(); });

  // Modes
  const MODES = {
    cute: { label:"Cute", badge:"YAYYYYY üíòüå∏‚ú®", sub:"PS: You just made my whole year üíñ", cursor:"üíó",
      emojis:["üíñ","üíò","üíù","üíï","üå∏","üå∑","üåπ","ü™ª","‚ú®","üíó"],
      fireworks:{ rocketEvery:520, extraChance:0.55, particleMult:1.0 } },
    chaotic: { label:"Chaotic", badge:"CHAOS ACCEPTED üòàüí•üíò", sub:"You chose‚Ä¶ wisely. Now suffer the confetti üòà‚ú®", cursor:"üí•",
      emojis:["üí•","üíò","üíó","‚ú®","üåπ","üòà","üíñ","üî•","üå∏","ü´∂"],
      fireworks:{ rocketEvery:360, extraChance:0.85, particleMult:1.45 } },
    nerdy: { label:"Nerdy", badge:"LOVE CONFIRMED ‚úÖüíòü§ì", sub:"Achievement unlocked: Valentine secured üèÜ", cursor:"üß†",
      emojis:["üíò","ü§ì","üß†","‚ú®","üå∏","üíñ","ü´∂","üì°","üß™","‚≠ê"],
      fireworks:{ rocketEvery:520, extraChance:0.6, particleMult:1.05 } },
  };
  let mode = "cute";
  function applyMode(m){
    mode = m;
    modeBtn.textContent = `üß† Mode: ${MODES[mode].label}`;
    badgeEl.textContent = MODES[mode].badge;
    submsgEl.textContent = MODES[mode].sub;
    cursorHeart.textContent = MODES[mode].cursor;
  }
  applyMode(mode);

  modeBtn.addEventListener('click', () => modal.classList.add('on'));
  modal.addEventListener('click', (e) => { if(e.target === modal) modal.classList.remove('on'); });
  modal.querySelectorAll('.mode').forEach(el => {
    el.addEventListener('click', () => { applyMode(el.dataset.mode); modal.classList.remove('on'); });
  });

  // Love meter
  let love = 0;
  let celebrating = false;

  function setLove(val){
    love = Math.max(0, Math.min(100, val));
    meterFill.style.width = love + "%";
    meterPct.textContent = love + "%";
    if(love >= 100){
      meterLabel.textContent = "Love Meter üíò (MAX)";
      setTimeout(() => { if(!celebrating) yesBtn.click(); }, 250);
    }
  }
  setLove(0);

  function bumpLove(){
    const inc = (love < 40) ? 9 : (love < 75) ? 12 : 18;
    setLove(love + inc);
    setCompliment(true);
  }

  // No button dodge (layout-safe)
  const noTexts = ["No üôÉ","Are you sure?","Really?","Please? ü•∫","Don't do this üíî","Last chance üò≠","Ok fine‚Ä¶ No?"];
  let noTextIndex = 0;
  function changeNoText(){ noTextIndex = (noTextIndex + 1) % noTexts.length; noBtn.textContent = noTexts[noTextIndex]; }

  function moveNoButton() {
    const stageRect = stage.getBoundingClientRect();
    const btnRect = noBtn.getBoundingClientRect();
    const pad = 12;
    const maxX = Math.max(pad, stageRect.width - btnRect.width - pad);
    const maxY = Math.max(pad, stageRect.height - btnRect.height - pad);
    const x = rand(pad, maxX);
    const y = rand(pad, maxY);
    noBtn.style.left = x + 'px';
    noBtn.style.top = y + 'px';
    noBtn.style.transform = 'translate(0,0)';
  }

  let noInitialized = false;
  function initNo(){ if(noInitialized) return; noInitialized = true; moveNoButton(); }
  window.addEventListener('load', initNo);
  window.addEventListener('resize', () => { initNo(); });

  const dodge = (e) => {
    e.preventDefault(); e.stopPropagation();
    initNo(); changeNoText(); moveNoButton(); bumpLove();
  };
  noBtn.addEventListener('mouseenter', () => { initNo(); changeNoText(); moveNoButton(); bumpLove(); });
  noBtn.addEventListener('pointerdown', dodge, { passive:false });
  noBtn.addEventListener('touchstart', dodge, { passive:false });
  noBtn.addEventListener('click', dodge);

  // Kiss counter
  let kisses = 0;
  function incKiss(){ kisses++; counterEl.textContent = `Kisses sent: ${kisses} üíã`; }

  // Cursor heart follow
  let targetX = window.innerWidth/2, targetY = window.innerHeight/2;
  let curX = targetX, curY = targetY;
  window.addEventListener('pointermove', (e) => { targetX = e.clientX; targetY = e.clientY; cursorHeart.classList.add('on'); });
  window.addEventListener('touchmove', (e) => {
    if(!e.touches || !e.touches[0]) return;
    targetX = e.touches[0].clientX; targetY = e.touches[0].clientY; cursorHeart.classList.add('on');
  }, { passive:true });
  (function followLoop(){
    curX += (targetX - curX) * 0.18;
    curY += (targetY - curY) * 0.18;
    cursorHeart.style.left = curX + "px";
    cursorHeart.style.top  = curY + "px";
    requestAnimationFrame(followLoop);
  })();

  // Falling emojis
  let fallInterval = null;
  function spawnFall(){
    const emojis = MODES[mode].emojis;
    const el = document.createElement('div');
    el.className = 'fall';
    el.textContent = emojis[Math.floor(Math.random()*emojis.length)];
    el.style.left = rand(0, window.innerWidth - 40) + 'px';
    el.style.setProperty('--dx', rand(-140, 140) + 'px');
    el.style.setProperty('--rot', rand(-720, 720) + 'deg');
    el.style.fontSize = rand(18, 40) + 'px';
    el.style.animationDuration = rand(3.2, 6.6) + 's';
    el.style.opacity = rand(0.75, 1);
    fallLayer.appendChild(el);
    el.addEventListener('animationend', () => el.remove());
  }
  function startFalling(ms=12000){
    for(let i=0;i<18;i++) setTimeout(spawnFall, i*80);
    fallInterval = setInterval(spawnFall, 140);
    setTimeout(() => { clearInterval(fallInterval); fallInterval=null; }, ms);
  }

  // Fireworks + confetti
  const canvas = document.getElementById('fx');
  const ctx = canvas.getContext('2d', { alpha:true });

  function resizeCanvas(){
    const dpr = window.devicePixelRatio || 1;
    canvas.width = Math.floor(window.innerWidth * dpr);
    canvas.height = Math.floor(window.innerHeight * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  const particles = [], rockets = [], confetti = [];
  let fxRunning = false, rocketTimer = null;

  function hsla(h,s,l,a){ return `hsla(${h}, ${s}%, ${l}%, ${a})`; }

  function makeRocket(){
    rockets.push({
      x: rand(window.innerWidth*0.2, window.innerWidth*0.8),
      y: window.innerHeight + 10,
      vx: rand(-1.2, 1.2),
      vy: rand(-10.5, -13.5),
      hue: (mode === "chaotic") ? rand(0, 360) : rand(320, 380),
      life: rand(35, 55)
    });
  }

  function drawHeart(x,y,size,color,alpha){
    ctx.save();
    ctx.globalAlpha = alpha;
    ctx.fillStyle = color;
    ctx.translate(x,y);
    ctx.scale(size,size);
    ctx.beginPath();
    ctx.moveTo(0, -0.3);
    ctx.bezierCurveTo(-0.5, -0.9, -1.2, -0.1, 0, 0.8);
    ctx.bezierCurveTo(1.2, -0.1, 0.5, -0.9, 0, -0.3);
    ctx.closePath();
    ctx.fill();
    ctx.restore();
  }

  function explode(r){
    const mult = MODES[mode].fireworks.particleMult;
    const count = Math.floor(rand(40, 70) * mult);

    for(let i=0;i<count;i++){
      const ang = rand(0, Math.PI*2);
      const spd = rand(2.0, 6.2) * (mode==="chaotic" ? 1.15 : 1.0);
      particles.push({
        x:r.x, y:r.y,
        vx: Math.cos(ang)*spd + rand(-0.3,0.3),
        vy: Math.sin(ang)*spd + rand(-0.3,0.3),
        hue: r.hue + rand(-18,18),
        alpha: 1,
        decay: rand(0.010, 0.020),
        size: rand(1.2, 2.7)
      });
    }
    const heartCount = Math.floor(8 * mult);
    for(let i=0;i<heartCount;i++){
      particles.push({
        x:r.x, y:r.y,
        vx: rand(-4,4) * mult,
        vy: rand(-4,4) * mult,
        hue: 345,
        alpha: 1,
        decay: rand(0.012, 0.020),
        size: rand(2.0, 3.2),
        heart: true
      });
    }
  }

  function confettiBurst(x,y, amount=120){
    for(let i=0;i<amount;i++){
      confetti.push({ x, y, vx: rand(-7,7), vy: rand(-10,-2), g: rand(0.18, 0.28), a: 1, d: rand(0.010, 0.018), s: rand(2,4), h: rand(0,360) });
    }
  }

  function startFireworks(duration=10000){
    if(fxRunning) return;
    fxRunning = true;

    const every = MODES[mode].fireworks.rocketEvery;
    const extraChance = MODES[mode].fireworks.extraChance;

    rocketTimer = setInterval(() => {
      makeRocket();
      if(Math.random() < extraChance) setTimeout(makeRocket, 180);
    }, every);

    setTimeout(() => { clearInterval(rocketTimer); rocketTimer=null; }, duration);
    requestAnimationFrame(tick);
  }

  function drawConfetti(){
    for(let i=confetti.length-1;i>=0;i--){
      const c = confetti[i];
      c.x += c.vx; c.y += c.vy; c.vy += c.g;
      c.vx *= 0.992; c.vy *= 0.992;
      c.a -= c.d;
      if(c.a <= 0 || c.y > window.innerHeight + 40){ confetti.splice(i,1); continue; }
      ctx.globalAlpha = Math.max(0, c.a);
      ctx.fillStyle = hsla(c.h, 95, 60, 1);
      ctx.fillRect(c.x, c.y, c.s, c.s);
    }
  }

  function tick(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    for(let i=rockets.length-1;i>=0;i--){
      const r = rockets[i];
      r.x += r.vx; r.y += r.vy; r.vy += 0.12; r.life--;
      ctx.globalAlpha = 0.9;
      ctx.beginPath(); ctx.arc(r.x, r.y, 2.2, 0, Math.PI*2);
      ctx.fillStyle = hsla(r.hue % 360, 90, 60, 0.9);
      ctx.fill();

      if(r.life <= 0 || r.vy >= -2.2){ explode(r); rockets.splice(i,1); }
    }

    for(let i=particles.length-1;i>=0;i--){
      const p = particles[i];
      p.x += p.vx; p.y += p.vy; p.vy += 0.06;
      p.vx *= 0.988; p.vy *= 0.988;
      p.alpha -= p.decay;
      if(p.alpha <= 0){ particles.splice(i,1); continue; }

      if(p.heart){
        drawHeart(p.x, p.y, p.size, hsla(345, 90, 60, 1), p.alpha);
      }else{
        ctx.globalAlpha = p.alpha;
        ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
        ctx.fillStyle = hsla(p.hue % 360, 95, 60, 1);
        ctx.fill();
      }
    }

    drawConfetti();

    if(fxRunning){
      if(rockets.length === 0 && particles.length === 0 && confetti.length === 0 && !rocketTimer){
        fxRunning = false;
        return;
      }
      requestAnimationFrame(tick);
    }
  }

  // Confetti on click after yes
  let allowClicksForConfetti = false;
  window.addEventListener('pointerdown', (e) => {
    if(!allowClicksForConfetti) return;
    confettiBurst(e.clientX, e.clientY, mode==="chaotic" ? 180 : 120);
    if(!fxRunning) startFireworks(2500);
  }, { passive:true });

  // Love letter
  function buildLetter(name){
    const n = name || "you";
    const openers = [`Hey ${n}‚Ä¶`, `${n}, quick confession‚Ä¶`, `Okay ${n}‚Äîhere‚Äôs the truth:`, `Dear ${n},`];
    const lines = [
      "I‚Äôve been looking for the right moment to say this in a simple, honest way.",
      "You have this rare kind of presence‚Äîlike things feel lighter when you‚Äôre around.",
      "I love the way you make ordinary moments feel like they matter.",
      "Even when we‚Äôre doing nothing special, it somehow feels‚Ä¶ special.",
      "I admire your heart, your mind, and the little details you don‚Äôt even notice you do.",
      "You deserve a love that feels safe, playful, and steady at the same time.",
      "So yes, this is me choosing you‚Äîsoftly, proudly, and without hesitation."
    ];
    const closers = [
      "If you‚Äôll let me, I‚Äôd love to be your valentine‚Äîand keep showing you, in small ways, how much you mean to me. üíñ",
      "So‚Ä¶ will you let me be your valentine? I promise: more laughs, more warmth, and a thousand tiny reasons to smile. üíò",
      "If you say yes, I‚Äôm not just celebrating today‚ÄîI‚Äôm celebrating the chance to make you feel loved, again and again. üíû"
    ];
    const pick = (arr) => arr[Math.floor(Math.random()*arr.length)];
    return [
      pick(openers),
      "",
      lines[0],
      lines[1],
      lines[Math.floor(Math.random()*lines.length)],
      lines[Math.floor(Math.random()*lines.length)],
      "",
      pick(closers)
    ].join("\n");
  }

  function typewriterMultiline(el, text, speed=14){
    el.textContent = "";
    let i = 0;
    const t = setInterval(() => {
      el.textContent += text[i++];
      if(i >= text.length) clearInterval(t);
    }, speed);
  }

  function showLetter(){
    letterTitle.textContent = currentName ? `A little note for ${currentName} üíå` : "A little note üíå";
    typewriterMultiline(letterBody, buildLetter(currentName || "you"), 14);
    letter.classList.add('on');
  }

  copyLetterBtn.addEventListener('click', async () => {
    try{
      await navigator.clipboard.writeText(letterBody.textContent);
      copyLetterBtn.textContent = "‚úÖ Copied";
      setTimeout(() => copyLetterBtn.textContent = "üìã Copy", 900);
    }catch(_){
      window.prompt("Copy this:", letterBody.textContent);
    }
  });
  rerollLetterBtn.addEventListener('click', () => showLetter());

  // 10) Compatibility
  function generateCompatibility(){
    const base = 92;
    const jitter = Math.floor(rand(0, 9));
    const score = Math.min(100, base + jitter);
    const reasons = [
      "same vibe, different chaos ‚ú®",
      "eye contact is a superpower üò≥",
      "laughs per minute: elite üíØ",
      "communication: dangerously good ü´∂",
      "taste in food: suspiciously aligned üçï",
      "playlist compatibility: certified üî•",
      "chemistry: not even subtle üíò"
    ];
    const r1 = reasons[Math.floor(Math.random()*reasons.length)];
    const r2 = reasons[Math.floor(Math.random()*reasons.length)];
    compatChip.textContent = `Compatibility: ${score}% ‚Ä¢ ${r1} ‚Ä¢ ${r2}`;
    compatWrap.classList.add("on");
  }

  // Celebration
  function showDateBox(){ pickDateIdea(); dateBox.classList.add('on'); }

  function startCelebration(){
    overlay.classList.add('on');

    setTimeout(() => submsgEl.classList.add('on'), 1400);
    setTimeout(generateCompatibility, 900);
    setTimeout(showDateBox, 1900);

    startFalling(12000);
    startFireworks(10000);
    setTimeout(showLetter, 5200);

    allowClicksForConfetti = true;

    yesBtn.disabled = true;
    yesBtn.style.animation = "none";
    yesBtn.textContent = "YES!!! üíò";
    noBtn.style.display = 'none';
  }

  // Share includes name
  shareBtn.addEventListener('click', async () => {
    const url = new URL(location.href);
    if(currentName) url.searchParams.set("name", currentName);
    else url.searchParams.delete("name");
    const shareUrl = url.toString();

    const shareData = { title: "Valentine?", text: "Will you be my valentine? üíò", url: shareUrl };
    try{
      if(navigator.share){
        await navigator.share(shareData);
        shareBtn.textContent = "‚úÖ Shared";
        setTimeout(() => shareBtn.textContent = "üíå Share", 1200);
      }else{
        await navigator.clipboard.writeText(shareUrl);
        shareBtn.textContent = "‚úÖ Link copied";
        setTimeout(() => shareBtn.textContent = "üíå Share", 1200);
      }
    }catch(_){
      window.prompt("Copy this link:", shareUrl);
    }
  });

  // 6) Konami code
  const KONAMI = ["arrowup","arrowup","arrowdown","arrowdown","arrowleft","arrowright","arrowleft","arrowright","b","a"];
  let kbuf = [];
  function triggerKonami(){
    overlay.classList.add('on');
    submsgEl.classList.add('on');
    generateCompatibility();
    showDateBox();
    startFalling(8000);
    startFireworks(8000);
    for(let i=0;i<5;i++){
      setTimeout(() => confettiBurst(window.innerWidth/2 + rand(-80,80), window.innerHeight*0.35 + rand(-40,40), 220), i*180);
    }
    setTimeout(showLetter, 900);
    setLove(100);
  }
  window.addEventListener('keydown', (e) => {
    const key = (e.key || "").toLowerCase();
    kbuf.push(key);
    if(kbuf.length > KONAMI.length) kbuf.shift();
    if(KONAMI.every((k, i) => kbuf[i] === k)){
      triggerKonami();
      kbuf = [];
    }
  });

  // LOVE easter egg
  let buffer = "";
  function triggerLoveEgg(){
    overlay.classList.add('on');
    submsgEl.classList.add('on');
    generateCompatibility();
    showDateBox();
    startFalling(6500);
    startFireworks(5500);
    confettiBurst(window.innerWidth/2, window.innerHeight*0.33, mode==="chaotic" ? 220 : 140);
    setTimeout(showLetter, 900);
  }
  window.addEventListener('keydown', (e) => {
    const k = (e.key || "").toLowerCase();
    if(!k || k.length !== 1) return;
    buffer = (buffer + k).slice(-6);
    if(buffer.endsWith("love")){ triggerLoveEgg(); buffer = ""; }
  });

  // YouTube Music: Elvis "Burning Love"
  const YT_VIDEO_ID = "zf2VYAtqRe0";
  let ytPlayer = null, ytReady = false, musicOn = false;

  window.onYouTubeIframeAPIReady = function(){
    ytPlayer = new YT.Player('yt-player', {
      width:'1', height:'1', videoId: YT_VIDEO_ID,
      playerVars: { autoplay:0, controls:0, rel:0, playsinline:1, mute:1, modestbranding:1 },
      events: { onReady: () => { ytReady = true; } }
    });
  };

  async function setMusic(on){
    musicOn = on;
    musicBtn.textContent = musicOn ? "üîä Music" : "üîá Music";
    if(!ytReady || !ytPlayer) return;
    try{
      if(musicOn){ ytPlayer.playVideo(); ytPlayer.unMute(); ytPlayer.setVolume(80); }
      else ytPlayer.pauseVideo();
    }catch(_){}
  }
  musicBtn.addEventListener('click', async () => setMusic(!musicOn));
  window.addEventListener('pointerdown', () => { if(musicOn) setMusic(true); }, { passive:true });

  // YES click
  yesBtn.addEventListener('click', async () => {
    if(celebrating) return;
    celebrating = true;

    incKiss();
    yesBtn.textContent = "Processing love... ‚è≥";

    await setMusic(true);
    setTimeout(() => startCelebration(), 900);
  });

  // 7) Glitter trail
  const glitter = document.getElementById("glitter");
  const gctx = glitter.getContext("2d", { alpha:true });
  const sparkles = [];

  function resizeGlitter(){
    const dpr = window.devicePixelRatio || 1;
    glitter.width = Math.floor(window.innerWidth * dpr);
    glitter.height = Math.floor(window.innerHeight * dpr);
    gctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }
  window.addEventListener("resize", resizeGlitter);
  resizeGlitter();

  function addSparkle(x,y){
    const emoji = (Math.random() < 0.55) ? "‚ú®" : "üíó";
    sparkles.push({
      x, y,
      vx: rand(-0.6, 0.6),
      vy: rand(-1.2, -0.2),
      a: 1,
      d: rand(0.018, 0.032),
      s: rand(12, 18),
      rot: rand(-1, 1),
      emoji
    });
    if(sparkles.length > 220) sparkles.splice(0, 40);
  }

  let lastSpark = 0;
  function onMove(x,y){
    const now = performance.now();
    if(now - lastSpark < 14) return;
    lastSpark = now;
    addSparkle(x,y);
  }

  window.addEventListener("pointermove", (e) => onMove(e.clientX, e.clientY), { passive:true });
  window.addEventListener("touchmove", (e) => {
    if(!e.touches || !e.touches[0]) return;
    onMove(e.touches[0].clientX, e.touches[0].clientY);
  }, { passive:true });

  function drawGlitter(){
    gctx.clearRect(0,0,glitter.width,glitter.height);
    for(let i=sparkles.length-1;i>=0;i--){
      const p = sparkles[i];
      p.x += p.vx;
      p.y += p.vy;
      p.vy += 0.02;
      p.a -= p.d;

      if(p.a <= 0){ sparkles.splice(i,1); continue; }

      gctx.save();
      gctx.globalAlpha = Math.max(0, p.a);
      gctx.translate(p.x, p.y);
      gctx.rotate(p.rot);
      gctx.font = `${p.s}px ui-sans-serif, system-ui, -apple-system`;
      gctx.fillText(p.emoji, 0, 0);
      gctx.restore();
    }
    requestAnimationFrame(drawGlitter);
  }
  drawGlitter();
})();
</script>
</body>
</html>
